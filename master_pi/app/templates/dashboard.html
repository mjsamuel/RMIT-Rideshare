{% extends "layout.html" %}

{% block content %}

<script>
    isLoggedIn();

    fetch("api/cars")
      .then(response => response.json())
      .then(data => {
        showCharts(data.cars)
      });
    function showCharts(cars){
      google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(drawChart);

// Draw the chart and set the chart values
function drawChart() {
  var data = new google.visualization.DataTable();
      data.addColumn('string', 'ID');
      data.addColumn('number', 'number of seats');
      data.addColumn('number', 'cost per hour');
      data.addColumn('string', 'Make');
      for (var i = 0; i < cars.length; ++i) {
      data.addRows([
        ['', cars[i].no_seats, cars[i].cost_per_hour,  cars[i].make]
      ]);
      }
  // Optional; add a title and set the width and height of the chart
  var options = {
    'width':500, 'height':800,
    title: 'Correlation between number of seats in car and cost per hour of that car',
    hAxis: {title: 'Number Of Seats'},
    vAxis: {title: 'Cost Per Hour'},
    bubble: {
      textStyle: {
        auraColor: 'none'
      }
    }
  };

  // Display the chart inside the <div> element with id="piechart"
  var chart = new google.visualization.BubbleChart(document.getElementById('bubblechart'));
  chart.draw(data, options);
}
    }

fetch("api/booking?car_id={{ car.id }}")
        .then(response => response.json())
        .then(data => {
          showCharts(data.bookings)
          showTimeline(data.bookings)
      });

    function showCharts(bookings){
      google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(drawChart);

// Draw the chart and set the chart values
function drawChart() {
  var data = new google.visualization.DataTable();
      data.addColumn('string', 'user');
      data.addColumn('number', 'timebooked');
      for (var i = 0; i < bookings.length; ++i) {
      data.addRows([
        [bookings[i].username, bookings[i].duration]
      ]);
      }
  // Optional; add a title and set the width and height of the chart
  var options = {'title':'Users who booked this car', 'width':650, 'height':400};

  // Display the chart inside the <div> element with id="piechart"
  var chart = new google.visualization.PieChart(document.getElementById('piechart'));
  chart.draw(data, options);
}
    }

    function showTimeline(bookings){
      google.charts.load('current', {'packages':['timeline']});
      google.charts.setOnLoadCallback(drawChart);
     // Draw the chart and set the chart values
      function drawChart() {
        var container = document.getElementById('timeline');
        var chart = new google.visualization.Timeline(container);
        var dataTable = new google.visualization.DataTable();

        dataTable.addColumn({ type: 'string', id: 'President' });
        dataTable.addColumn({ type: 'date', id: 'Start' });
        dataTable.addColumn({ type: 'date', id: 'End' });
        for (var i = 0; i < bookings.length; ++i) {

          let bookTime = moment.utc(bookings[i].book_time).toDate()
          let formattedBookTime = moment(bookTime).format('YYYY, M, D, H, m');
          let fa = moment(bookTime).format('YYYY');
          let fb = moment(bookTime).format('M');
          let fc = moment(bookTime).format('D');
          let fd = moment(bookTime).format('H');
          let fg = moment(bookTime).format('m');
          let prebookTimeEnd = moment.utc(bookings[i].book_time).add(bookings[i].duration, 'hours');
          let bookTimeEnd = moment.utc(prebookTimeEnd).toDate()
          let formattedBookTimeEnd = moment(bookTimeEnd).format('YYYY, M, D, H, m');  
          let fea = moment(bookTimeEnd).format('YYYY');
          let feb = moment(bookTimeEnd).format('M');
          let fec = moment(bookTimeEnd).format('D');
          let fed = moment(bookTimeEnd).format('H');
          let feg = moment(bookTimeEnd).format('m');
        dataTable.addRows([
          [ bookings[i].username, new Date(fa, fb, fc, fd, fg), new Date(fea, feb, fec, fed, feg) ]
          ]);
        }
        var options = {
          title: 'A timeline of all bookings made on this car',
          width: 500,
          height: 500
        };

        chart.draw(dataTable, options);
      }
    }


</script>


    <h1>User Time Booked</h1>
      <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
      <h1>Bubble Chart</h1>
      <div id="bubblechart"></div>
      <h1>Pie Chart</h1>
      <div id="piechart"></div>
      <h1>Booking Timeline</h1>
      <div id="timeline"></div>



{% endblock %}